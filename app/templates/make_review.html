{% extends "base.html" %}
{% block content %}

<meta id="milestoneitem_epa" data-milestone_item_epa_linkage="{{ milestone_item_epa_linkage }}"
    data-milestone_items="{{milestone_items}}" data-epa_milestones="{{epa_milestones}}">

<form action="" method="post">
    <div class="container">
        {{ form.hidden_tag() }}
        {{ form.csrf_token }}
        <div class='row justify-content-md-center review-form'>
            <div class="text-center col-md-6 mb-3">
                <div class="card">
                    <div class="card-body" style='padding:0.3rem 1rem'>
                        {% if review.is_draft %}
                        <div class='row justify-content-start col-2'>
                            <span class="badge bg-danger mb-2 ">暫存</span>
                        </div>
                        {% elif review.complete %}
                        <div class='row justify-content-start col-2'>
                            <span class="badge bg-success mb-2">已完成</span>
                        </div>
                        {% else %}
                        <div class='row justify-content-start col-2'>
                            <span class="badge bg-warning text-dark mb-2 justify-content-md-start">未完成</span>
                        </div>
                        {% endif %}
                        
                        <h6 class="card-subtitle mb-2 text-muted">
                            {% if review.review_source.name == 'request' %}
                            <h5 class="card-title">{{title}} - 傳送給老師</h5>
                            <p class="mt-1" style="font-size: 10px;font-weight:normal;color:grey">老師可選擇所屬及外訓醫院的總醫師或主治醫師</p>
                            {% elif review.review_source.name == 'new' %}
                            <h5 class="card-title">{{title}} - 評核學生</h5>
                            <p class="mt-1" style="font-size: 5px;font-weight:normal;color:grey">學生可選擇所屬及外訓醫院有選貴醫院的住院醫師</p>
                            {% endif %}
                        </h6>

                        <p class="card-text">{{card_desc}}</p>

                    </div>
                </div>
            </div>

            <div class="w-100"></div>
            <div class="text-center col-md-6 mb-3">
                <div class="d-grid gap-2 d-flex justify-content-md-end">
                    <div id="btn_epa_milestones" class="text-right btn-sm btn-light">EPA查詢</div>
                </div>
                {% for field in showing_fields %}
                <div class="form-floating">
                    {% if field.type in ["SelectField"] %}
                    {{ field(**{"class":"selectpicker form-control", "data-live-search": "true"}) }}
                    {% elif field.type == "TextAreaField"%}
                    {{ field(class="form-control", style="height: 100px;margin-bottom:1rem") }}
                    {% elif field.type == "RadioField"%}

                    {{ field(class="form-control", style="block-size: fit-content;text-align: left;padding: 2rem;font-size:14px") }}

                    {% else %}
                    {{ field(class="form-control form-check") }}
                    {% endif %}
                    {{ field.label }}
                    {% for error in field.errors %}
                    <div class="text-danger"><span style="color: red;">[{{ error }}]</span></div>
                    {% endfor %}
                </div>

                {% endfor %}
            </div>

            <div class="w-100"></div>
            <div class="text-center col-md-6 mb-3">

                {% if review_type != "inspect" %}
                {% if review.complete == False %}
                {{ form.submit_draft(title=form.submit_draft.description, class="col-3 btn btn-outline-dark mt-1 m-3")}}
                {% endif %}
                {{ form.submit(title=form.submit.description, class="col-3 btn btn-outline-primary mt-1 m-3")}}
                {% else %}
                    <a href="{{url_for('view_all_reviews')}}" class="w-100 btn btn-outline-primary">回查看所有評核</a>
                {% endif %}
                <p></p>
            </div>

        </div>
</form>
<div class="modal fade" id="epa_milestone_modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">EPA連結的次核心能力</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<script>
    $("#btn_epa_milestones").on("click", (e) => {
        var selectedText = $('#epa :selected').text();
        var selected_epa_code = selectedText.match(/EPA\d+/)[0]
        selected_epa_code = selected_epa_code.substring(0, 3) + parseInt(selected_epa_code.substring(3))
        console.log(selected_epa_code)
        var epa_milestones = find_epa_milestone(selected_epa_code)
        var htmltext = "<ul>" + epa_milestones.map(x => "<li>" + x + "</li>").join("") + "<ul>"
        var $epa_modal = $('#epa_milestone_modal')
        $epa_modal.find(".modal-body").html(htmltext)
        $epa_modal.find(".modal-title").html(selectedText)
        $epa_modal.modal('show');

    });
    function find_epa_milestone(epa) {
        var epa_milestones = $("#milestoneitem_epa").data("epa_milestones")
        return epa_milestones[epa].map(x => x['name'] + " " + x['desc'])
    }

    function find_epa_milestone_items(epa) {
        var linkages = $("#milestoneitem_epa")
        var milestone_item_epa_linkage = linkages.data("milestone_item_epa_linkage") //mies show the all epa level-miletone item linkage
        var milestone_items = linkages.data("milestone_items") //  mis show the milestone item content
        var re = milestone_item_epa_linkage[epa]
        re['contents'] = re['milestone_item_codes'].map(x => milestone_items[x])
        return re
    }
</script>

{% endblock %}